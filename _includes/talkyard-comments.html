{% if site.talkyard_server_url %}
<section id="comments-container" role="region" aria-label="Comments section" class="comments-container">
  <h2 class="comments-title">Comments</h2>
  <div id="comments-placeholder" class="comments-placeholder" aria-busy="true" aria-label="Loading comments, please wait">
    <p>Loading comments...</p>
  </div>
  <div id="talkyard-comments-wrapper" class="comments-wrapper" aria-busy="false">
    <div class="talkyard-comments" data-discussion-id="{{ page.discussion_id }}" role="main">
      <noscript><p class="noscript-message">Please enable Javascript to view comments.</p></noscript>
    </div>
  </div>
</section>

<script>
(function() {
  var commentsLoaded = false;
  var commentsContainer = document.getElementById('comments-container');
  var placeholder = document.getElementById('comments-placeholder');
  var wrapper = document.getElementById('talkyard-comments-wrapper');
  
  function loadComments() {
    if (commentsLoaded) return;
    commentsLoaded = true;
    
    if (window.performance && window.performance.mark) {
      performance.mark('comments-load-start');
    }
    
    window.talkyardServerUrl = '{{ site.talkyard_server_url }}';
    
    var script = document.createElement('script');
    script.src = '{{ site.talkyard_script_url }}';
    script.async = true;
    script.defer = true;
    // Security attributes for third-party script
    script.setAttribute('crossorigin', 'anonymous');
    script.onload = function() {
      placeholder.style.display = 'none';
      wrapper.style.display = 'block';
      wrapper.removeAttribute('aria-busy');
      placeholder.removeAttribute('aria-busy');

      if (window.performance && window.performance.mark) {
        performance.mark('comments-load-end');
        performance.measure('comments-load-time', 'comments-load-start', 'comments-load-end');
      }
    };
    script.onerror = function() {
      placeholder.innerHTML = '<p style="color: #999;">Comments could not be loaded. Please check your connection.</p>';
      console.error('Failed to load Talkyard comments script from: {{ site.talkyard_script_url }}');
    };
    document.head.appendChild(script);
  }
  
  if ('IntersectionObserver' in window) {
    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          loadComments();
          observer.disconnect();
        }
      });
    }, {
      rootMargin: '200px'
    });
    
    observer.observe(commentsContainer);
  } else {
    setTimeout(loadComments, 2000);
  }
})();
</script>
{% endif %}
